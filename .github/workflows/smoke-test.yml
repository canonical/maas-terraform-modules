name: Run MAAS Terraform modules Smoke Tests

on:
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA to test (for fork PRs). WARNING: Review entire PR before dispatch - code executes on self-hosted runner!"
        required: true

jobs:
  run-smoke:
    runs-on: self-hosted-linux-amd64-noble-private-endpoint-medium
    steps:
      # Validate commit SHA format
      - name: Validate commit SHA format
        run: |
          if ! [[ "${{ github.event.inputs.commit-sha }}" =~ ^[a-f0-9]{40}$ ]]; then
            echo "Error: Invalid commit SHA format. Must be a full 40-character SHA."
            exit 1
          fi

      # Checkout trusted test infrastructure from main branch
      - name: Checkout trusted test infrastructure
        uses: actions/checkout@v4
        with:
          ref: main
          path: trusted

      # Checkout modules to test from PR
      - name: Checkout modules to test
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit-sha }}
          path: untrusted
          sparse-checkout: |
            modules

      - name: Report pending status
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.inputs.commit-sha }} \
            -f state=pending \
            -f context="Smoke Test (Manual)" \
            -f description="Running smoke tests..." \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ github.token }}

      # Prepare Testflinger attachments using trusted scripts
      - name: Prepare Testflinger attachments
        working-directory: trusted/tests
        run: |
          # Copy modules from untrusted PR to trusted terraform location
          cp -r ../../untrusted/modules/* terraform/modules/
          # Create tarball with terraform directory only
          tar -czf tests.tar.gz terraform/
          # Write smoke test flag
          echo "true" > run_smoke_test.txt

      - name: Run on Testflinger
        uses: canonical/testflinger/.github/actions/submit@987fd7ab1467065217a9c6496eb2c3d85a250509
        with:
          poll: true
          job-path: ./trusted/tests/testflinger.yaml
          attachments-relative-to: ./trusted/tests/

      - name: Report success status
        if: success()
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.inputs.commit-sha }} \
            -f state=success \
            -f context="Smoke Test (Manual)" \
            -f description="Smoke tests passed" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Report failure status
        if: failure()
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.inputs.commit-sha }} \
            -f state=failure \
            -f context="Smoke Test (Manual)" \
            -f description="Smoke tests failed" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ github.token }}
